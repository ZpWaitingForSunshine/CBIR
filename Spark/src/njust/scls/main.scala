package njust.scls

import breeze.linalg.{*, DenseMatrix, inv, sum}
import breeze.numerics.{pow, sqrt}
import njust.tools.{HSIInputFormat, HSIhdr, JTool}
import org.apache.spark.{SparkConf, SparkContext}

object main {

  def main(args: Array[String]): Unit = {
    if (args.length < 4) {
          val str =
            """
              | ucls
              |args(0): filename
              |args(1): hdfsip
              |args(2): jobname
              |args(3): sparkip
            """
          println(str)
          sys.exit(-1)
        }
    val filename = args(0)
    val hdfsIP = args(1)
    val jobname = args(2)
    val sparkip = args(3)

    // get HSI header
    val header = new HSIhdr(filename, hdfsIP)
    val bands = header.getBands // bands
    val row = header.getRow     // row
    val col = header.getCol     // col
    val len = col * row         // len
    val datatype = header.getDatatype
    val interler = header.getInter

    //init M infomation
    val cols = 5
    //
    val theta = 0.01

    val t1 = System.currentTimeMillis()

    // init spark
    val sparkConf = new SparkConf().setAppName(jobname)
      .setMaster(sparkip)
    val spark = new SparkContext(sparkConf)

    // init endmembers M
    //val M =new DenseMatrix(bands,cols,Array(0.612089,0.630838,0.647065,0.658492,0.667166,0.678414,0.689653,0.702848,0.716622,0.732610,0.745529,0.759429,0.772398,0.782074,0.786520,0.794713,0.802359,0.806222,0.810823,0.814565,0.820215,0.821622,0.827588,0.832425,0.836913,0.839864,0.831647,0.836371,0.839646,0.842981,0.847174,0.852397,0.857558,0.860703,0.863010,0.865493,0.869448,0.871706,0.872848,0.876034,0.877416,0.879567,0.880928,0.881478,0.882552,0.881283,0.883430,0.884339,0.882325,0.881084,0.877402,0.881196,0.880563,0.880461,0.878334,0.879303,0.877348,0.876596,0.878501,0.878943,0.880076,0.878423,0.878345,0.878637,0.880709,0.883567,0.884391,0.884689,0.885838,0.887256,0.886847,0.889313,0.889690,0.889385,0.889743,0.891546,0.891760,0.890868,0.892092,0.890042,0.890473,0.890915,0.892952,0.891256,0.891816,0.891832,0.891687,0.887990,0.889806,0.888520,0.888807,0.886302,0.884558,0.885202,0.887878,0.889437,0.887691,0.884866,0.880202,0.876949,0.872472,0.872293,0.867409,0.766509,0.760151,0.746649,0.741515,0.762106,0.780252,0.793855,0.802970,0.807881,0.812284,0.812841,0.813341,0.814014,0.814572,0.814733,0.814313,0.813625,0.811997,0.811411,0.808366,0.805918,0.803080,0.801155,0.800475,0.797049,0.790270,0.779747,0.763753,0.745734,0.730850,0.722563,0.726465,0.748371,0.764656,0.771279,0.773412,0.773527,0.773455,0.605626,0.606905,0.609125,0.608849,0.606993,0.608609,0.609358,0.607833,0.606461,0.604197,0.600621,0.596827,0.583918,0.565173,0.539341,0.509488,0.487254,0.479216,0.485395,0.500617,0.514085,0.524541,0.543395,0.567768,0.591772,0.603167,0.608956,0.608603,0.603662,0.591970,0.573683,0.545393,0.524176,0.514703,0.513840,0.514032,0.509033,0.498030,0.478316,0.456305,0.436750,0.423899,0.409878,0.392873,0.376348,0.366072,0.355796,0.347579,0.341866,0.336148,0.330358,0.262132,0.239735,0.308768,0.340404,0.361536,0.383373,0.413668,0.442262,0.472162,0.498476,0.523746,0.542435,0.556687,0.567752,0.575486,0.583871,0.593558,0.602672,0.610689,0.619781,0.629515,0.641521,0.654002,0.669278,0.684923,0.698628,0.666762,0.683515,0.696655,0.707919,0.719406,0.727067,0.736216,0.740490,0.744485,0.746588,0.748099,0.746478,0.742818,0.737319,0.726793,0.717498,0.707446,0.697271,0.685535,0.676601,0.672475,0.669334,0.669246,0.668575,0.674678,0.679900,0.690753,0.695199,0.701642,0.712656,0.731539,0.741051,0.753740,0.763984,0.771744,0.779085,0.787698,0.795815,0.801306,0.807412,0.812960,0.820337,0.823694,0.826832,0.833830,0.836231,0.841227,0.843179,0.846569,0.851636,0.854059,0.855732,0.861787,0.860128,0.864021,0.866267,0.868843,0.868377,0.872112,0.872603,0.873228,0.875132,0.875458,0.877958,0.877527,0.880039,0.880408,0.881196,0.880789,0.882637,0.882149,0.882243,0.883367,0.883008,0.883635,0.883905,0.881567,0.893679,0.895793,0.898988,0.900266,0.900679,0.901558,0.903540,0.904106,0.905700,0.906434,0.908677,0.909032,0.909326,0.909471,0.908031,0.910127,0.909299,0.908828,0.910338,0.907915,0.908333,0.906499,0.909585,0.907708,0.907849,0.907863,0.907573,0.904866,0.907119,0.908815,0.908405,0.909713,0.910386,0.912026,0.908494,0.907335,0.906456,0.908130,0.894353,0.897878,0.897272,0.900141,0.897598,0.897785,0.899122,0.896658,0.895062,0.897374,0.895392,0.893118,0.897174,0.894948,0.891143,0.884992,0.880357,0.871308,0.853820,0.840666,0.829236,0.809116,0.794828,0.782120,0.774812,0.777610,0.782265,0.785177,0.785246,0.789551,0.791255,0.787293,0.790510,0.795331,0.794157,0.783245,0.765781,0.743422,0.714694,0.694938,0.687936,0.694898,0.700473,0.702644,0.704238,0.698350,0.692462,0.687593,0.683962,0.680327,0.676174,0.271263,0.282092,0.293069,0.304817,0.314642,0.326465,0.337303,0.347861,0.358391,0.370230,0.380496,0.392203,0.404328,0.415065,0.428857,0.438364,0.448855,0.457268,0.466788,0.476626,0.485130,0.494024,0.502199,0.511685,0.519811,0.528418,0.510942,0.518407,0.526042,0.534594,0.541470,0.546619,0.554357,0.560934,0.566386,0.571750,0.577874,0.583840,0.587912,0.594605,0.599666,0.603810,0.609139,0.613227,0.617834,0.619873,0.621436,0.619229,0.620958,0.625179,0.621088,0.626061,0.628315,0.627627,0.624735,0.626756,0.626939,0.627256,0.631265,0.631123,0.631601,0.631998,0.633024,0.637018,0.633805,0.635287,0.637373,0.635192,0.636532,0.637710,0.635404,0.638514,0.638218,0.638776,0.641084,0.642779,0.643459,0.644011,0.642751,0.645519,0.645683,0.647743,0.647914,0.648540,0.649273,0.649317,0.649889,0.650981,0.652220,0.651276,0.651429,0.652095,0.654091,0.654880,0.654375,0.655397,0.658182,0.658581,0.659791,0.660479,0.662047,0.662009,0.661542,0.663665,0.660123,0.660768,0.658382,0.653420,0.650214,0.645101,0.636361,0.628143,0.624254,0.619799,0.623242,0.632805,0.637792,0.641461,0.645596,0.645264,0.645104,0.646422,0.651510,0.654895,0.653823,0.654577,0.658790,0.658496,0.655774,0.654549,0.659088,0.659292,0.661160,0.658075,0.658653,0.659484,0.659361,0.659614,0.656689,0.657795,0.648055,0.489261,0.466514,0.458860,0.454399,0.460598,0.458611,0.451729,0.449481,0.440958,0.417908,0.397172,0.381667,0.377404,0.382105,0.389070,0.398210,0.410092,0.419657,0.431215,0.445628,0.453156,0.461705,0.471537,0.481392,0.496927,0.507601,0.514934,0.525206,0.539974,0.548918,0.548348,0.548840,0.555077,0.556289,0.550720,0.553202,0.559357,0.566760,0.570275,0.570576,0.570823,0.569496,0.567846,0.565385,0.563053,0.562381,0.561709,0.561679,0.562433,0.563187,0.562403,0.442575,0.429592,0.417112,0.405348,0.396269,0.388724,0.385067,0.382988,0.384717,0.388170,0.395727,0.404611,0.414963,0.427388,0.441639,0.455912,0.471325,0.485754,0.499857,0.515078,0.528133,0.540418,0.554403,0.565294,0.579602,0.591287,0.562997,0.577665,0.590325,0.601361,0.613727,0.625783,0.637217,0.648498,0.659370,0.668020,0.678933,0.688711,0.697572,0.706072,0.711782,0.719731,0.726601,0.733617,0.737124,0.740457,0.744170,0.756531,0.760179,0.763759,0.767560,0.769987,0.772648,0.772166,0.773938,0.779298,0.780060,0.783872,0.784445,0.792981,0.796027,0.797253,0.800716,0.801423,0.804803,0.806196,0.808462,0.810492,0.812579,0.814732,0.815780,0.820159,0.818990,0.820382,0.820580,0.820779,0.823445,0.824924,0.825636,0.825483,0.828401,0.827263,0.831407,0.829854,0.830560,0.831030,0.829594,0.829000,0.830517,0.833477,0.833046,0.834540,0.832039,0.829917,0.824815,0.823073,0.823250,0.819868,0.818387,0.818344,0.808624,0.801745,0.789629,0.791407,0.799197,0.814687,0.819314,0.823543,0.822123,0.822541,0.822903,0.823337,0.822122,0.819838,0.818640,0.816499,0.815758,0.812941,0.808368,0.806166,0.803002,0.799551,0.795855,0.792495,0.787763,0.782202,0.779743,0.773847,0.767758,0.760943,0.756433,0.751537,0.750619,0.746974,0.746880,0.745556,0.744941,0.740538,0.736528,0.733287,0.728785,0.655003,0.651711,0.650183,0.647878,0.641734,0.638010,0.634933,0.626177,0.620908,0.615807,0.614217,0.606217,0.601091,0.592756,0.575820,0.540741,0.492369,0.485029,0.487642,0.477976,0.470061,0.488359,0.516363,0.516116,0.498042,0.483575,0.477792,0.481664,0.487393,0.490486,0.482360,0.469014,0.461472,0.462288,0.457464,0.450786,0.450944,0.448956,0.440200,0.434556,0.433568,0.427807,0.421812,0.415200,0.408806,0.405247,0.401687,0.397866,0.393719,0.389568,0.386323,0.168112,0.174121,0.179276,0.181176,0.184212,0.185808,0.189214,0.191939,0.196327,0.200272,0.202831,0.206449,0.210276,0.213340,0.219328,0.223745,0.230962,0.240399,0.249616,0.257614,0.265568,0.271985,0.279831,0.285788,0.293276,0.301231,0.285318,0.292529,0.299712,0.307255,0.314615,0.321486,0.329122,0.335770,0.342280,0.347614,0.351906,0.356314,0.359760,0.362660,0.363846,0.366138,0.368381,0.370117,0.371719,0.373076,0.376373,0.377070,0.378681,0.381426,0.384222,0.389991,0.392217,0.396920,0.399152,0.405712,0.412685,0.416978,0.423250,0.430925,0.436788,0.442607,0.446647,0.453732,0.457996,0.462292,0.466595,0.472294,0.475093,0.480323,0.483063,0.488554,0.491603,0.496895,0.499749,0.502347,0.507460,0.512058,0.515263,0.515679,0.520086,0.524303,0.528237,0.532070,0.536377,0.538173,0.541794,0.542597,0.546214,0.550339,0.549864,0.551271,0.554822,0.558043,0.557577,0.557959,0.559290,0.560082,0.561682,0.559062,0.555727,0.552117,0.534582,0.555148,0.561770,0.570029,0.577112,0.583098,0.588694,0.596793,0.597929,0.601565,0.606605,0.611140,0.613166,0.614558,0.618547,0.619290,0.621414,0.623936,0.625938,0.627649,0.629246,0.629501,0.631051,0.632376,0.635130,0.636494,0.634648,0.632061,0.632974,0.631748,0.631388,0.629288,0.626589,0.626483,0.622130,0.619975,0.619553,0.616910,0.617993,0.513617,0.525096,0.534142,0.540783,0.544885,0.548943,0.550831,0.550596,0.549029,0.547106,0.545098,0.540006,0.536585,0.527446,0.504241,0.467950,0.431243,0.409834,0.396325,0.387538,0.362953,0.378830,0.434324,0.464843,0.473031,0.475547,0.475207,0.470584,0.462180,0.451775,0.437324,0.423873,0.415319,0.410958,0.403453,0.391891,0.383697,0.373870,0.361912,0.355948,0.355168,0.351131,0.345656,0.336588,0.327664,0.320629,0.313592,0.306209,0.298392,0.290568,0.283517,0.265228,0.278683,0.291262,0.302198,0.307928,0.313954,0.322920,0.332134,0.342753,0.353720,0.363519,0.375359,0.386972,0.396861,0.407762,0.418691,0.428893,0.439086,0.447887,0.454650,0.463055,0.469394,0.476012,0.483996,0.491746,0.499610,0.482910,0.489944,0.497842,0.504282,0.512465,0.517728,0.525425,0.531983,0.538446,0.543419,0.547940,0.552051,0.556626,0.559524,0.562417,0.564089,0.567365,0.569326,0.568945,0.570678,0.572419,0.572377,0.572172,0.573798,0.575484,0.578979,0.581149,0.580515,0.582048,0.586066,0.589249,0.590615,0.594233,0.598764,0.603140,0.606006,0.610313,0.611367,0.614252,0.617314,0.619907,0.623802,0.625813,0.628556,0.632404,0.632849,0.636367,0.639328,0.640343,0.643725,0.644819,0.645653,0.647166,0.649100,0.652543,0.653396,0.659144,0.658298,0.662521,0.663402,0.664661,0.666094,0.668081,0.670711,0.670295,0.672359,0.673048,0.674460,0.674687,0.671331,0.671886,0.670086,0.669466,0.667633,0.661914,0.654250,0.637345,0.625022,0.635499,0.646700,0.653918,0.662038,0.667286,0.674961,0.678397,0.679838,0.684196,0.687106,0.689510,0.690693,0.693892,0.696814,0.697068,0.698624,0.699178,0.700900,0.703825,0.702196,0.701677,0.702085,0.704929,0.705155,0.702013,0.700891,0.696776,0.697707,0.695731,0.692567,0.690524,0.687607,0.684343,0.681743,0.679422,0.678201,0.677739,0.554281,0.565488,0.577643,0.586573,0.593913,0.597873,0.599950,0.603175,0.602790,0.601577,0.601491,0.601384,0.599531,0.593256,0.577333,0.549623,0.516645,0.491184,0.475957,0.466717,0.447885,0.459108,0.497747,0.519114,0.528180,0.535047,0.536898,0.534524,0.530616,0.519263,0.504783,0.492995,0.483113,0.475108,0.467703,0.457041,0.446924,0.436982,0.425833,0.418349,0.414375,0.407601,0.399726,0.389074,0.378748,0.372667,0.366587,0.359696,0.351807,0.343911,0.336955,0.366648,0.408131,0.475913,0.539630,0.575433,0.595966,0.609664,0.617839,0.624656,0.629774,0.634721,0.640286,0.645241,0.649345,0.656946,0.660163,0.664303,0.668874,0.673674,0.677477,0.681330,0.684901,0.688426,0.691078,0.695986,0.699234,0.690180,0.694918,0.698110,0.703017,0.707803,0.706707,0.710587,0.713534,0.716915,0.720117,0.720602,0.722845,0.723732,0.724206,0.723795,0.724001,0.723329,0.723430,0.721175,0.720901,0.718955,0.715117,0.714050,0.714236,0.714336,0.713433,0.714120,0.712769,0.712989,0.715028,0.715545,0.713798,0.714675,0.718730,0.721201,0.723398,0.721894,0.721954,0.723564,0.724353,0.726092,0.725272,0.726126,0.724891,0.727123,0.727440,0.728946,0.730067,0.730520,0.731367,0.731844,0.733090,0.733508,0.734256,0.734730,0.734380,0.736900,0.737436,0.737261,0.740267,0.739892,0.740196,0.741323,0.741525,0.741670,0.742052,0.742810,0.744491,0.742613,0.741956,0.739959,0.741992,0.741945,0.742869,0.742015,0.739874,0.736810,0.740509,0.740585,0.744675,0.745534,0.746275,0.747318,0.749907,0.748625,0.750198,0.749779,0.751802,0.749933,0.749783,0.750648,0.750695,0.750361,0.750926,0.750359,0.751479,0.749957,0.750282,0.748165,0.749751,0.751706,0.752672,0.748795,0.747615,0.747203,0.748524,0.748059,0.745748,0.743476,0.746320,0.746733,0.745106,0.741496,0.740775,0.738158,0.713509,0.717616,0.718852,0.718987,0.720041,0.720689,0.720798,0.720658,0.717201,0.710440,0.704225,0.696843,0.692838,0.691927,0.687210,0.675754,0.654098,0.615290,0.553297,0.491623,0.475153,0.515185,0.562535,0.588997,0.606751,0.621493,0.629663,0.635191,0.635874,0.633159,0.620037,0.597308,0.572233,0.547617,0.529593,0.523393,0.529921,0.533037,0.530243,0.528183,0.526166,0.512922,0.500762,0.491214,0.482577,0.485767,0.488956,0.493248,0.498891,0.504540,0.510113,0.224825,0.250157,0.270536,0.280673,0.283461,0.291170,0.303123,0.322154,0.345283,0.370729,0.398154,0.426862,0.453473,0.476453,0.496067,0.510164,0.520661,0.528983,0.534628,0.539744,0.543619,0.547473,0.551949,0.556426,0.561488,0.565382,0.556396,0.559935,0.564531,0.569760,0.574992,0.580956,0.587330,0.590592,0.596565,0.599585,0.604740,0.608739,0.609672,0.613336,0.614892,0.614902,0.617288,0.619151,0.618605,0.620585,0.618419,0.614207,0.616058,0.615759,0.611215,0.614218,0.614729,0.615774,0.616859,0.618477,0.616997,0.619042,0.622255,0.623067,0.625397,0.626493,0.631372,0.632587,0.637857,0.640055,0.644843,0.646037,0.650218,0.653561,0.657335,0.658814,0.660876,0.665271,0.668418,0.671639,0.676063,0.678992,0.680300,0.684039,0.687741,0.691365,0.694460,0.694118,0.699013,0.698887,0.701604,0.703029,0.704987,0.707105,0.707435,0.709248,0.710374,0.713057,0.711406,0.714513,0.713418,0.714293,0.715337,0.715158,0.713777,0.712193,0.704476,0.698964,0.704261,0.708669,0.712237,0.718039,0.715847,0.719484,0.721566,0.722308,0.724256,0.725911,0.726978,0.727664,0.729270,0.731361,0.733556,0.733609,0.734498,0.736800,0.736605,0.734557,0.736840,0.735625,0.739074,0.737843,0.738631,0.738322,0.734348,0.737099,0.736753,0.733384,0.735838,0.729768,0.730427,0.729348,0.731180,0.728904,0.727253,0.634974,0.638455,0.642256,0.647254,0.650772,0.652030,0.650946,0.649889,0.646758,0.637790,0.633988,0.632991,0.631919,0.633153,0.636899,0.634554,0.627248,0.618000,0.599070,0.569965,0.532712,0.513505,0.519599,0.547858,0.578101,0.600828,0.615139,0.622945,0.617539,0.610635,0.599804,0.582461,0.563568,0.546175,0.532822,0.527121,0.529647,0.534921,0.534603,0.529731,0.523610,0.515868,0.508293,0.501083,0.494354,0.493878,0.493402,0.492264,0.490317,0.488368,0.486307,0.094355,0.097181,0.101982,0.109440,0.123646,0.143596,0.159393,0.170317,0.182411,0.195313,0.213431,0.237117,0.254522,0.275637,0.290682,0.302655,0.306881,0.304640,0.302394,0.297378,0.295198,0.292114,0.292501,0.301020,0.305075,0.315732,0.297931,0.303660,0.312161,0.328347,0.341189,0.359317,0.374437,0.391292,0.403737,0.416351,0.420430,0.427276,0.429205,0.431767,0.430727,0.428395,0.422747,0.422501,0.415669,0.415334,0.411878,0.398935,0.392664,0.387418,0.382341,0.378940,0.376112,0.371965,0.372118,0.368109,0.369773,0.366951,0.371450,0.373290,0.374211,0.378426,0.382010,0.385667,0.393702,0.397895,0.404941,0.411904,0.417455,0.424143,0.433839,0.439897,0.446719,0.454134,0.461607,0.468319,0.474209,0.481898,0.486212,0.488220,0.493141,0.498102,0.502798,0.506239,0.510996,0.512819,0.516745,0.518362,0.520289,0.522208,0.522557,0.522836,0.524128,0.525595,0.525143,0.526228,0.525258,0.521208,0.519336,0.516850,0.515854,0.513571,0.505867,0.441852,0.453133,0.464626,0.472223,0.481400,0.483928,0.491394,0.499424,0.500438,0.503018,0.505831,0.508241,0.511110,0.514188,0.513624,0.515790,0.517433,0.517638,0.520419,0.522458,0.522906,0.521818,0.526145,0.522598,0.521900,0.520964,0.526797,0.520260,0.519461,0.517023,0.518159,0.511109,0.509935,0.509279,0.508481,0.507860,0.508967,0.505093,0.369733,0.382551,0.397150,0.410339,0.418482,0.428550,0.436474,0.441874,0.446401,0.450198,0.455623,0.459879,0.463750,0.467538,0.469559,0.469693,0.470696,0.467164,0.464403,0.458780,0.456426,0.450708,0.444761,0.436879,0.432236,0.424850,0.407059,0.374624,0.338247,0.328263,0.348202,0.380107,0.393507,0.394304,0.387923,0.379043,0.368017,0.352036,0.333445,0.318201,0.307551,0.305915,0.304123,0.301934,0.299381,0.292117,0.284853,0.277231,0.269162,0.261085,0.255081,0.173535,0.167514,0.190604,0.200712,0.207671,0.214759,0.226467,0.241383,0.254828,0.267043,0.281433,0.293569,0.303514,0.319519,0.333071,0.345728,0.359792,0.375636,0.390358,0.402473,0.416747,0.431500,0.446411,0.459419,0.475569,0.489300,0.458140,0.472645,0.488044,0.498846,0.509953,0.523629,0.532798,0.540939,0.550775,0.563193,0.567025,0.576618,0.577973,0.582539,0.584403,0.583747,0.580890,0.579952,0.577551,0.572233,0.570643,0.568733,0.572212,0.574256,0.573458,0.581735,0.584544,0.595210,0.602346,0.612306,0.621690,0.629907,0.637547,0.644605,0.649396,0.657099,0.662371,0.664174,0.668068,0.671234,0.676396,0.678406,0.676610,0.684479,0.682462,0.681263,0.683536,0.686264,0.686547,0.683417,0.686792,0.683086,0.684621,0.684689,0.684301,0.681466,0.682290,0.679554,0.680215,0.676895,0.676990,0.677886,0.676809,0.675164,0.675332,0.677773,0.677354,0.675928,0.674592,0.677210,0.678849,0.678223,0.681640,0.682693,0.685052,0.687107,0.690932,0.719630,0.717222,0.720907,0.719545,0.727371,0.726539,0.727051,0.727198,0.729919,0.730539,0.731030,0.728139,0.726975,0.729863,0.726477,0.725355,0.727433,0.725752,0.725771,0.724506,0.724799,0.723862,0.724129,0.718097,0.724440,0.720138,0.721727,0.720178,0.722906,0.718547,0.719491,0.718598,0.714073,0.718360,0.717944,0.713545,0.714362,0.715586,0.724520,0.726113,0.728961,0.730867,0.731536,0.733959,0.732314,0.736295,0.735974,0.737943,0.741879,0.745733,0.744114,0.743239,0.743872,0.743855,0.742890,0.744200,0.742710,0.740265,0.738638,0.737294,0.740827,0.737959,0.736108,0.737586,0.739474,0.738976,0.738129,0.734316,0.734739,0.736449,0.734796,0.737411,0.734844,0.734468,0.736151,0.736542,0.732959,0.731141,0.732946,0.731001,0.729526,0.729207,0.728810,0.727382,0.725954,0.725515,0.726285,0.727055,0.726880,0.095176,0.097107,0.097526,0.101306,0.102690,0.104451,0.105204,0.108855,0.111592,0.114038,0.119097,0.123470,0.129774,0.131495,0.137677,0.142377,0.148201,0.154253,0.161241,0.165733,0.170546,0.175336,0.182246,0.187089,0.192650,0.197924,0.186758,0.191083,0.196757,0.200586,0.204049,0.207968,0.215190,0.219233,0.221264,0.226158,0.231369,0.238364,0.242170,0.245584,0.249307,0.251543,0.254031,0.258660,0.262761,0.265694,0.266182,0.268103,0.269306,0.270242,0.270673,0.270934,0.273068,0.275107,0.277023,0.279625,0.279041,0.281769,0.281915,0.282352,0.283025,0.284376,0.284398,0.283399,0.284219,0.286765,0.286316,0.286594,0.288132,0.287401,0.288785,0.289386,0.292377,0.291674,0.293210,0.294306,0.295832,0.298168,0.298834,0.301900,0.300178,0.300308,0.304618,0.303927,0.306371,0.309371,0.310020,0.313007,0.315784,0.314489,0.314355,0.318756,0.319938,0.319576,0.322437,0.324304,0.326929,0.326215,0.327632,0.328204,0.331707,0.333064,0.332993,0.342038,0.342784,0.342835,0.344878,0.346963,0.346654,0.348933,0.346738,0.349738,0.351577,0.351490,0.352697,0.353176,0.352847,0.354423,0.354993,0.356497,0.356012,0.354990,0.356335,0.358238,0.358922,0.355087,0.354366,0.359403,0.360059,0.362133,0.358698,0.362300,0.361858,0.362647,0.365343,0.362511,0.363130,0.364423,0.364548,0.364431,0.363427,0.370583,0.371273,0.371208,0.374225,0.374166,0.376244,0.373963,0.376602,0.376514,0.379605,0.376978,0.379350,0.383224,0.382969,0.381483,0.378723,0.375850,0.377851,0.376419,0.374858,0.371874,0.373451,0.375307,0.374290,0.372687,0.369846,0.370785,0.371449,0.374515,0.370207,0.370293,0.370162,0.366933,0.368313,0.368506,0.368405,0.371050,0.372843,0.371149,0.368529,0.366808,0.368324,0.369372,0.369266,0.369122,0.368486,0.367850,0.366948,0.365721,0.364491,0.363737,0.466630,0.476814,0.485949,0.493255,0.496650,0.501813,0.506320,0.513203,0.520577,0.527266,0.534097,0.541914,0.549042,0.556016,0.559733,0.565918,0.569140,0.571818,0.574345,0.576605,0.578893,0.580608,0.584034,0.585712,0.589531,0.591008,0.585746,0.589151,0.590639,0.594207,0.599826,0.604106,0.609939,0.614204,0.616945,0.621166,0.625710,0.630027,0.633590,0.636447,0.640669,0.643838,0.645680,0.650947,0.652341,0.656017,0.659752,0.664890,0.667322,0.669146,0.667955,0.669970,0.670795,0.671952,0.673237,0.674584,0.676227,0.677697,0.679277,0.679520,0.681850,0.683236,0.685370,0.685241,0.688539,0.690040,0.690938,0.691771,0.693142,0.694201,0.695451,0.696224,0.695942,0.696780,0.697484,0.699990,0.699557,0.699192,0.698951,0.699997,0.699305,0.700699,0.702581,0.701781,0.703095,0.702439,0.702217,0.703678,0.701704,0.701982,0.701570,0.702152,0.701277,0.702320,0.701416,0.702025,0.700577,0.699336,0.696579,0.695481,0.691057,0.687728,0.680637,0.623975,0.627690,0.632120,0.635191,0.637884,0.642092,0.646434,0.648359,0.651265,0.654232,0.656740,0.655826,0.656890,0.658780,0.658928,0.660783,0.660204,0.660446,0.661696,0.661272,0.661961,0.661166,0.659926,0.661557,0.661790,0.659896,0.659402,0.657986,0.658325,0.655817,0.653978,0.653067,0.653589,0.652145,0.651298,0.649001,0.648979,0.648189,0.563332,0.571286,0.577657,0.582413,0.586754,0.589232,0.591291,0.591381,0.590930,0.591766,0.592003,0.591281,0.590272,0.587747,0.583112,0.574229,0.561085,0.542854,0.519384,0.497390,0.482478,0.474334,0.471564,0.471167,0.469983,0.469035,0.470118,0.471648,0.475066,0.477955,0.478790,0.483672,0.491249,0.496457,0.499499,0.500797,0.501846,0.502919,0.500288,0.495645,0.490730,0.481574,0.472575,0.463916,0.455083,0.444011,0.432940,0.423070,0.414654,0.406231,0.398919))
    val M = new DenseMatrix(bands,cols,Array(0.075513,0.079429,0.082509,0.085582,0.090763,0.096912,0.102746,0.106436,0.109307,0.114328,0.121318,0.127030,0.130526,0.135781,0.138909,0.139668,0.140160,0.140573,0.140074,0.138159,0.135468,0.132261,0.128418,0.124533,0.120591,0.116791,0.113129,0.109764,0.106672,0.104022,0.101447,0.099487,0.104786,0.102267,0.100096,0.098566,0.097271,0.096635,0.096547,0.097281,0.098339,0.099732,0.101872,0.104107,0.106282,0.108599,0.110309,0.111348,0.110952,0.111121,0.110483,0.108691,0.109736,0.107880,0.103537,0.103931,0.103779,0.102020,0.101989,0.103107,0.105036,0.105616,0.105928,0.108997,0.110481,0.111456,0.112801,0.113588,0.114814,0.115430,0.115138,0.115938,0.115949,0.115828,0.116250,0.116602,0.116641,0.117493,0.118211,0.118929,0.119709,0.121214,0.122569,0.123855,0.125755,0.127757,0.129684,0.132712,0.134820,0.137358,0.140954,0.143703,0.146702,0.150695,0.153652,0.157556,0.151527,0.154891,0.158832,0.162734,0.166327,0.170389,0.173965,0.178395,0.181976,0.186135,0.189777,0.193740,0.198271,0.201773,0.202341,0.200935,0.205023,0.214249,0.219581,0.222931,0.226688,0.229971,0.234210,0.240001,0.243942,0.247241,0.251320,0.254715,0.258794,0.261442,0.265336,0.270147,0.274029,0.277897,0.282634,0.287106,0.291606,0.295886,0.301477,0.305281,0.309855,0.314569,0.318455,0.322677,0.327889,0.333203,0.337300,0.339918,0.344153,0.348204,0.351055,0.355869,0.358700,0.363381,0.369542,0.370569,0.373123,0.375976,0.378640,0.381349,0.384020,0.385295,0.386908,0.388398,0.388398,0.390305,0.395285,0.398905,0.400026,0.403864,0.406353,0.404351,0.404265,0.407263,0.406370,0.404871,0.406289,0.407664,0.416575,0.426485,0.432815,0.441204,0.446564,0.450028,0.454010,0.456289,0.458885,0.460949,0.462357,0.462384,0.464594,0.467029,0.466529,0.466762,0.463193,0.460372,0.457689,0.452475,0.444420,0.429788,0.398955,0.359384,0.350807,0.365658,0.375848,0.371019,0.356167,0.347968,0.342384,0.332689,0.320637,0.318141,0.327332,0.346578,0.369717,0.377724,0.386869,0.391320,0.395055,0.396357,0.393768,0.390548,0.381917,0.377356,0.368158,0.364286,0.360860,0.354810,0.578123,0.594715,0.609301,0.621416,0.631695,0.643794,0.656367,0.668325,0.677724,0.685579,0.692866,0.699933,0.707853,0.715707,0.723504,0.730520,0.736501,0.741245,0.745455,0.749890,0.753707,0.756549,0.758548,0.760462,0.762510,0.766244,0.769272,0.771456,0.774613,0.776441,0.778424,0.781511,0.776043,0.777580,0.780231,0.783997,0.788178,0.792312,0.796652,0.798543,0.801387,0.802842,0.804726,0.806927,0.807370,0.809045,0.809302,0.810692,0.809738,0.809973,0.807433,0.808595,0.809985,0.809706,0.810927,0.811522,0.813480,0.816137,0.812935,0.813069,0.814819,0.814394,0.813675,0.815324,0.815277,0.814942,0.816086,0.817479,0.818835,0.819762,0.820025,0.821636,0.822856,0.823176,0.823974,0.824672,0.825520,0.825205,0.826385,0.825084,0.827143,0.826333,0.825905,0.825377,0.820634,0.819945,0.821948,0.821591,0.821685,0.823055,0.823003,0.824412,0.824668,0.825362,0.827679,0.827577,0.825727,0.828177,0.827481,0.828899,0.828324,0.829610,0.827719,0.826610,0.823365,0.821942,0.819469,0.817920,0.817707,0.814036,0.805938,0.791851,0.773924,0.756718,0.748346,0.746304,0.750846,0.754413,0.757169,0.759942,0.765296,0.770746,0.773933,0.775428,0.778680,0.779114,0.779137,0.783359,0.783455,0.783010,0.785079,0.787160,0.788221,0.788763,0.790712,0.791841,0.794686,0.795821,0.795516,0.796477,0.800420,0.801101,0.800804,0.797616,0.797188,0.794925,0.791168,0.787925,0.783416,0.785772,0.785297,0.787007,0.787624,0.787285,0.787640,0.788932,0.787231,0.780092,0.766670,0.744578,0.744577,0.710710,0.662560,0.602658,0.547758,0.523551,0.523528,0.528370,0.533319,0.538300,0.549764,0.565388,0.582841,0.602495,0.623912,0.638632,0.643735,0.647772,0.652345,0.653619,0.656569,0.661025,0.665587,0.672132,0.680153,0.687857,0.693277,0.698151,0.699497,0.702000,0.706393,0.706884,0.706752,0.708810,0.712051,0.716267,0.719846,0.722961,0.722429,0.725289,0.730700,0.727755,0.723957,0.720376,0.710743,0.702045,0.693456,0.680351,0.669387,0.654792,0.640857,0.635523,0.610983,0.591310,0.572526,0.553715,0.538549,0.530607,0.516807,0.511074,0.501431,0.498940,0.498327,0.503313,0.853566,0.859592,0.863808,0.866442,0.871136,0.873385,0.875988,0.877263,0.880795,0.883631,0.886800,0.890962,0.892946,0.895108,0.896576,0.898914,0.901076,0.901773,0.905223,0.905546,0.906608,0.909161,0.910663,0.910628,0.911492,0.912143,0.910716,0.913645,0.915110,0.916331,0.918019,0.917365,0.916248,0.917989,0.917986,0.916156,0.916060,0.915788,0.915627,0.912624,0.913283,0.911698,0.914092,0.915039,0.916434,0.917487,0.916046,0.916901,0.920246,0.919177,0.912578,0.910650,0.916245,0.925817,0.919897,0.916521,0.915324,0.911639,0.912885,0.904453,0.901587,0.887496,0.869466,0.850718,0.849311,0.863134,0.872865,0.880981,0.893187,0.900989,0.903164,0.908756,0.910845,0.910881,0.913946,0.909752,0.909151,0.908603,0.903790,0.898144,0.890124,0.871270,0.835868,0.806125,0.800060,0.813240,0.826691,0.830839,0.836054,0.842369,0.841896,0.849064,0.849726,0.848460,0.851082,0.848965,0.849358,0.850765,0.848623,0.845022,0.833412,0.820896,0.806068,0.784998,0.764818,0.746858,0.729546,0.712199,0.688459,0.651967,0.586816,0.513410,0.460668,0.441165,0.455205,0.486302,0.512043,0.521688,0.534574,0.562156,0.589204,0.610515,0.627033,0.642137,0.650172,0.658766,0.668048,0.673095,0.678622,0.683831,0.686822,0.689641,0.691177,0.697722,0.696917,0.701244,0.700292,0.706177,0.706755,0.706666,0.703253,0.699660,0.697437,0.687975,0.684674,0.671664,0.661896,0.661605,0.650723,0.646629,0.633252,0.627960,0.624124,0.617786,0.611871,0.604917,0.590775,0.564858,0.521968,0.454678,0.454675,0.363735,0.263512,0.199647,0.194027,0.215265,0.243592,0.268858,0.287485,0.302148,0.313816,0.330744,0.350958,0.368705,0.384865,0.403440,0.419686,0.432304,0.447479,0.454989,0.457014,0.464491,0.471162,0.480031,0.488558,0.492235,0.501542,0.506591,0.507375,0.512236,0.518082,0.515680,0.516282,0.520330,0.517829,0.519602,0.516391,0.509424,0.502828,0.499297,0.493865,0.482000,0.467033,0.452191,0.435411,0.417556,0.400329,0.380631,0.364563,0.343904,0.321525,0.312637,0.288479,0.273840,0.260806,0.247221,0.236379,0.231263,0.222645,0.218428,0.207598,0.202015,0.196674,0.186724,0.306966,0.317610,0.325834,0.331813,0.336837,0.343236,0.350182,0.355664,0.360178,0.363078,0.366320,0.369486,0.373358,0.375973,0.379721,0.382168,0.384753,0.385608,0.386671,0.386991,0.386779,0.386269,0.387173,0.385999,0.385430,0.383235,0.382246,0.382518,0.382523,0.382764,0.383511,0.383696,0.382712,0.383450,0.383333,0.383950,0.383908,0.386031,0.387279,0.389105,0.390853,0.390885,0.392742,0.392716,0.394141,0.394391,0.392303,0.393662,0.395058,0.393036,0.394134,0.396651,0.395936,0.393225,0.389792,0.388935,0.390659,0.389622,0.387899,0.385762,0.387377,0.385809,0.382039,0.384598,0.381616,0.381281,0.378440,0.379927,0.377858,0.376234,0.376164,0.374819,0.375053,0.374632,0.372944,0.372722,0.370113,0.371851,0.372764,0.371308,0.371017,0.371904,0.371639,0.372582,0.372501,0.371399,0.372475,0.370962,0.372035,0.371733,0.372646,0.373975,0.373712,0.374328,0.373653,0.375309,0.374102,0.374089,0.375098,0.375179,0.374705,0.376506,0.377039,0.377156,0.377785,0.379215,0.379731,0.381266,0.381797,0.381294,0.381041,0.380284,0.382379,0.383622,0.384461,0.386961,0.388580,0.390980,0.390016,0.392171,0.394689,0.395869,0.395868,0.396823,0.396637,0.399906,0.399723,0.402157,0.403070,0.402948,0.403575,0.406195,0.405662,0.405987,0.405594,0.406990,0.406272,0.407606,0.410104,0.408795,0.407180,0.411466,0.412793,0.412236,0.412178,0.413267,0.415410,0.412968,0.413003,0.411730,0.414417,0.415576,0.413754,0.413222,0.414398,0.415071,0.417295,0.417465,0.416344,0.415510,0.415510,0.414772,0.413934,0.410347,0.408788,0.410522,0.412459,0.411232,0.411526,0.413732,0.413762,0.415678,0.415312,0.416155,0.416903,0.418307,0.418815,0.418632,0.420854,0.419807,0.420514,0.425080,0.422967,0.421204,0.423486,0.424101,0.423604,0.421620,0.419326,0.415322,0.414820,0.412254,0.412677,0.414204,0.414437,0.413981,0.411253,0.410332,0.404876,0.401112,0.407089,0.408569,0.404802,0.408330,0.404491,0.397184,0.396484,0.397508,0.399506,0.401984,0.406335,0.408169,0.407457,0.407620,0.408285,0.407950,0.406939,0.406466,0.406005,0.405984,0.406221,0.406253,0.406055,0.404734,0.178848,0.197631,0.215622,0.232635,0.251232,0.274895,0.301989,0.322421,0.332459,0.339180,0.348463,0.363762,0.386662,0.413080,0.442891,0.474755,0.508058,0.538873,0.567130,0.589792,0.607525,0.620079,0.629234,0.635976,0.641582,0.645717,0.649604,0.653336,0.657277,0.661678,0.665493,0.669836,0.660343,0.664264,0.668026,0.673092,0.677569,0.682528,0.686485,0.690524,0.693967,0.697827,0.700739,0.702349,0.704324,0.704123,0.703174,0.702232,0.701804,0.700184,0.695800,0.695292,0.692062,0.686662,0.683937,0.682328,0.679324,0.679427,0.675947,0.680360,0.677739,0.676310,0.675939,0.673754,0.677435,0.680627,0.681828,0.683020,0.686920,0.688972,0.691695,0.692493,0.692565,0.696310,0.699389,0.702271,0.705641,0.707503,0.712199,0.714354,0.718353,0.720831,0.722504,0.721748,0.724966,0.731284,0.734401,0.738289,0.740288,0.745633,0.748240,0.750603,0.753174,0.756407,0.757973,0.759846,0.756902,0.758542,0.760567,0.760986,0.759898,0.759340,0.759332,0.755998,0.754554,0.751717,0.748398,0.742815,0.728642,0.701943,0.655086,0.602149,0.559055,0.567539,0.604442,0.637458,0.653594,0.659037,0.667959,0.682111,0.696690,0.706410,0.713730,0.722275,0.728499,0.734961,0.738379,0.744255,0.746675,0.751098,0.752743,0.753996,0.756210,0.759042,0.761728,0.762642,0.762885,0.762881,0.762901,0.761471,0.760924,0.763195,0.755675,0.753184,0.750388,0.746732,0.743369,0.736015,0.734101,0.729955,0.724843,0.722223,0.720421,0.716119,0.714410,0.709974,0.699038,0.686147,0.654015,0.598670,0.598668,0.521854,0.437141,0.397390,0.415979,0.446900,0.469770,0.483860,0.495559,0.510042,0.518453,0.528728,0.545039,0.562071,0.573743,0.584244,0.591174,0.597506,0.603650,0.606959,0.609813,0.608801,0.607882,0.607741,0.609734,0.610361,0.612349,0.608233,0.599680,0.588639,0.566111,0.536499,0.499301,0.468515,0.463377,0.476762,0.501653,0.529086,0.550129,0.553746,0.551717,0.545694,0.529533,0.511788,0.494819,0.479031,0.467985,0.464073,0.461635,0.456568,0.446600,0.442937,0.429270,0.420317,0.412251,0.403469,0.395838,0.391857,0.384907,0.381848,0.375513,0.372558,0.369629,0.363371))
    val ones = DenseMatrix.ones[Double](1, cols)

    val N = DenseMatrix.vertcat(M * theta ,ones)

    val t2 = System.currentTimeMillis()
    println("calu NN" +  (t2 - t1))

    // broadcast
    val af =spark.broadcast(inv(N.t * N) * N.t, bands, M)
    val bconf = spark.broadcast(row, col, bands, datatype.toShort, interler)

    val t3 = System.currentTimeMillis()
    println("broadcast" +  (t3 - t2))

    // init load image
    val file = spark.newAPIHadoopFile(hdfsIP + filename, classOf[HSIInputFormat], classOf[Integer], classOf[Array[Byte]])

    val t4 = System.currentTimeMillis()
    println("read data" +  (t4- t3))

    // map operation
    val rmse = file.map(pair => {
       val datatype = bconf.value._4 match {
           case 2 => 2.toShort
           case 4 => 4.toShort
           case 12 => 2.toShort
           case _ => {
             println("不支持的datasize格式!");
                0.toShort
             sys.exit(-1)
           }
       }
       val data = pair._2 // classOf[Array[Byte]]
       val len = data.length // size of this partition(Byte)
       val col = bconf.value._2
       val bands = bconf.value._3
//            val key = pair._1 / (bands * datatype) * len
       val pixel = len / (datatype * bands)
       println("pixel: " + pixel)
       val fdata = bconf.value._5 match { //header.getInter.toLowerCase()
           case "bil" => JTool.BtoFBil(data, pixel, col.toShort, bands.toShort, datatype)
           case "bip" => JTool.BtoFBip(data, pixel, bands.toShort, datatype)
           case _ => {
             println("不支持的interleave格式!")
             sys.exit(-1)
           }
       }

        // fdataMatirx is the partition data
        val fdataMatrix = DenseMatrix.tabulate(fdata.length, bands){ // rows 192 cols n
          case (i, j) => fdata(i)(j)
        }
        val ones = DenseMatrix.ones[Double](1, fdata.length)

      // each partition data plus ones for calu the abundance
        val X = DenseMatrix.vertcat(fdataMatrix.t * 0.0001 * theta, ones)

        val M = af.value._3 // endmembers set (bands * number)
      val abundance = (af.value._1 * X)

      val dataB = fdataMatrix.t * 0.0001
      val dataAx = M * abundance

//      abundance

      // M and fdataMatrix is a short array ,whose range is from 0 - 10000
        sum(pow(dataB  - dataAx, 2)) / bands
    }).reduce((x, y)=>{
      x + y
    })
    val t5 = System.currentTimeMillis()
    println("final" +  (t5- t4))
    println("rmse:" + sqrt(rmse / len))
  }

}
